---
tags:
  - projects
  - governance
  - access-control
  - isolation
  - keycloak
  - datahub
  - qraft
created: '2025-11-30'
updated: '2025-11-30'
status: 운영중
team: ML Platform (T)
period: 2025-09 ~ 2025-11
company: 크래프트테크놀로지스
---
# 팀별 데이터 격리 체계

## 📋 Overview

**기간**: 2025년 9월 ~ 11월  
**주도**: ML Platform (T)  
**배경**: Strategy 팀 HFT DAG 수정 사고 → CFO "팀별 완전 격리" 요구  
**결과**: Keycloak + DataHub + Airflow 3계층 격리 완성

---

## 🔥 격리가 필요했던 이유

### 사고 발생 (2025년 9월)

**상황**:
- Strategy (T) 팀원이 DAG 수정 중 실수로 HFT (T) DAG 수정
- HFT 실시간 트레이딩 파이프라인 **1시간 중단**
- 막대한 거래 손실

**당시 시스템**:
- ❌ Airflow 권한 관리 없음 → 모든 팀이 모든 DAG 수정 가능
- ❌ Owner 정보 없음 → "이 DAG 누구껀지" 확인 불가
- ❌ 팀별 구분 없음 → 실수로 다른 팀 리소스 건드림

### CFO 요구사항

[[데이터-거버넌스-전략-수립|거버넌스 전략]] 회의에서:

> **"팀별로 데이터를 완전히 격리할 수 없나?"**

**구체적 요구**:
1. 각 팀은 자기 팀 DAG/데이터만 수정 가능
2. 다른 팀 데이터는 읽기만 가능 (또는 접근 불가)
3. 누가 어떤 데이터 소유하는지 명확히 표시
4. 실수로 다른 팀 리소스 건드리는 일 원천 차단

### 추가 발견 문제 (2025년 10월 27일)

[[2025년-10월-27일|주간 회고]]에서 드러난 팀 간 갈등:

> **"왜 잘하는 우리 팀이 못하는 팀에게 데이터 공유해야 하나?"**

**팀별 우려**:
- **Strategy (T)**: 핵심 알고리즘 포함된 데이터 → IP 노출 우려
- **HFT (T)**: 실시간 트레이딩 데이터 → 외부 유출 시 큰 손실
- **MFT (T)**: 자체 개발 지수 구성 로직 → 경쟁 우위 보호

→ **단순 권한 분리가 아닌, 팀별 완전 격리 필요**

---

## 🏗️ 격리 아키텍처

### 3계층 격리 전략

```
┌──────────────────────────────────────────────────────────────┐
│                    1️⃣ Keycloak (인증 계층)                    │
│  ┌────────────┬────────────┬────────────┬──────────────────┐ │
│  │ Strategy(T)│   HFT (T)  │  MFT (T)   │ ML Platform (T) │ │
│  │            │            │            │     (Admin)      │ │
│  └────────────┴────────────┴────────────┴──────────────────┘ │
└──────────────────────────────────────────────────────────────┘
                              │
                              ↓ Group 동기화
┌──────────────────────────────────────────────────────────────┐
│                  2️⃣ DataHub (메타데이터 계층)                 │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ Owner 기반 정책:                                         │ │
│  │  - Owner = Strategy (T) → Strategy만 수정               │ │
│  │  - Owner = HFT (T) → HFT만 수정                         │ │
│  │  - Owner = Public → 모두 읽기, Admin만 수정             │ │
│  └─────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────┘
                              │
                              ↓ 메타데이터 연동
┌──────────────────────────────────────────────────────────────┐
│                  3️⃣ Airflow (실행 계층)                       │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ DAG-level Access Control:                               │ │
│  │  - DAG tags: "team:Strategy (T)"                        │ │
│  │  - Strategy 그룹만 DAG 조회/실행/수정 가능              │ │
│  │  - 다른 팀은 DAG 존재조차 모름                          │ │
│  └─────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────┘
```

### 계층별 역할

| 계층 | 역할 | 격리 단위 | 기술 |
|------|------|-----------|------|
| **Keycloak** | 사용자 인증, 그룹 관리 | User → Group 매핑 | OIDC, JIT Provisioning |
| **DataHub** | 메타데이터 권한 관리 | Owner 기반 접근 제어 | Owner-based Policies |
| **Airflow** | DAG 실행 권한 관리 | Team tag 기반 필터링 | Custom Auth Manager |

---

## 🔐 계층별 구현

### Layer 1: Keycloak (인증 계층)

**Group 구조**:
```
Keycloak Realm: qraft
├── ml-platform-admin        # 전체 관리자
├── Strategy (T)             # Strategy 팀
├── HFT (T)                  # HFT 팀
├── MFT (T)                  # MFT 팀
├── ML Platform (T)          # ML Platform 팀
├── AI Product (T)           # AI Product 팀
└── Public                   # 공개 그룹
```

**User → Group 매핑**:
```yaml
# 예시
qraft_hongjinyoung:
  groups:
    - ML Platform (T)
    - ml-platform-admin

strategy_user1:
  groups:
    - Strategy (T)

hft_user1:
  groups:
    - HFT (T)
```

**핵심 설계**:
- 그룹명: `{팀명} (T)` 형식 (T = Team)
- Admin 그룹: `ml-platform-admin` (별도)
- URN 인코딩: `quote_plus` 통일 → `urn:li:corpGroup:ML+Platform+%28T%29`

[[Keycloak-OIDC-인증|Keycloak 기술 상세]]

### Layer 2: DataHub (메타데이터 계층)

**Owner 기반 정책**:

```python
# apply_policies.py
POLICIES = [
    {
        "name": "ML Platform Full Admin",
        "description": "ML Platform (T)는 모든 엔티티 조회+편집+삭제",
        "type": "METADATA",
        "actors": {
            "groups": ["urn:li:corpGroup:ML+Platform+%28T%29"]
        },
        "privileges": [
            "VIEW_ENTITY_PAGE",
            "EDIT_ENTITY",
            "EDIT_ENTITY_TAGS",
            "DELETE_ENTITY",
            "EDIT_LINEAGE",
        ],
    },
    {
        "name": "Owners Can View and Edit",
        "description": "Owner 그룹 멤버만 조회+편집 가능",
        "type": "METADATA",
        "actors": {"resourceOwners": True},  # Owner 그룹
        "privileges": [
            "VIEW_ENTITY_PAGE",
            "EDIT_ENTITY",
            "EDIT_ENTITY_TAGS",
            "EDIT_LINEAGE",
        ],
    },
    {
        "name": "Public Owner - All Users Read",
        "description": "Owner=Public → 모든 사용자 읽기 가능",
        "type": "METADATA",
        "state": "ACTIVE",
        "actors": {"allUsers": True},
        "resources": {
            "filter": {
                "criteria": [
                    {
                        "field": "OWNER",
                        "value": "urn:li:corpGroup:Public",
                        "condition": "EQUALS",
                    }
                ]
            }
        },
        "privileges": ["VIEW_ENTITY_PAGE"],
    },
]
```

**권한 매트릭스**:

| Dataset Owner | Strategy (T) | HFT (T) | ML Platform (T) |
|--------------|:------------:|:-------:|:---------------:|
| **Owner = Strategy (T)** | ✅ 조회+편집 | ❌ 접근 불가 | ✅ 조회+편집 |
| **Owner = HFT (T)** | ❌ 접근 불가 | ✅ 조회+편집 | ✅ 조회+편집 |
| **Owner = Public** | ✅ 읽기 전용 | ✅ 읽기 전용 | ✅ 조회+편집 |

**Owner 자동 추출**:
```python
# DBT _models.yml
models:
  - name: us_simul_data
    meta:
      owner: "urn:li:corpGroup:Strategy+%28T%29"  # ← Strategy 팀 소유
      technical_owner: "urn:li:corpGroup:ML+Platform+%28T%29"
      datahub:
        domain: "urn:li:domain:USSimulation"
```

[[DataHub-도입|DataHub 구축 상세]]

### Layer 3: Airflow (실행 계층)

**Custom Auth Manager 구현**:

```python
# airflow/teams/qraft/plugins/auth/keycloak_auth_manager.py
class KeycloakAuthManager(BaseAuthManager):
    def get_permitted_dag_ids(self, user=None) -> set[str]:
        """사용자가 접근 가능한 DAG 필터링"""
        if not user:
            return set()
        
        # 1. Admin은 모든 DAG 접근
        if self.is_admin(user):
            return set(DagModel.get_dagbag().dag_ids)
        
        # 2. 사용자 그룹 가져오기
        user_groups = self._get_user_groups(user)
        
        # 3. DAG tags와 그룹 매칭
        permitted_dags = set()
        for dag_id, dag in DagModel.get_dagbag().dags.items():
            dag_teams = [
                tag.replace("team:", "")
                for tag in dag.tags
                if tag.startswith("team:")
            ]
            
            # DAG에 team tag 없으면 Public
            if not dag_teams:
                permitted_dags.add(dag_id)
                continue
            
            # 사용자 그룹과 DAG team 매칭
            if any(team in user_groups for team in dag_teams):
                permitted_dags.add(dag_id)
        
        return permitted_dags
```

**DAG 태깅 규칙**:
```python
# dags/qraft/strategy/us_simul_dag.py
from airflow import DAG

dag = DAG(
    dag_id="strategy_us_simul_etl",
    tags=[
        "layer:mart",
        "domain:us_simul_data",
        "team:Strategy (T)",  # ← Strategy 팀만 접근 가능
        "vendor:ciq",
    ],
    default_args={...},
)
```

**접근 제어 흐름**:
```
1. 사용자 로그인 (Keycloak SSO)
   → JWT Token 획득 (groups claim 포함)

2. Airflow Custom Auth Manager
   → Token 검증 → groups 추출
   → "Strategy (T)" 그룹 확인

3. DAG 목록 요청
   → get_permitted_dag_ids() 호출
   → DAG tags 필터링
   → "team:Strategy (T)" DAG만 반환

4. UI 렌더링
   → Strategy 팀: 자기 팀 DAG만 보임
   → HFT 팀: 자기 팀 DAG만 보임
   → Admin: 모든 DAG 보임
```

[[Airflow-3.0-구현|Airflow 기술 상세]]

---

## 🔗 통합 동작 방식

### Scenario 1: Strategy 팀 사용자 로그인

**Step 1: Keycloak 인증**
```
User: strategy_user1@qraft.ai
Groups: ["Strategy (T)"]

→ OIDC 로그인
→ Access Token 발급
   {
     "sub": "strategy_user1",
     "groups": ["Strategy (T)"],
     "email": "strategy_user1@qraft.ai"
   }
```

**Step 2: Airflow 접근**
```
→ Custom Auth Manager → JIT Provisioning
   - Airflow DB에 사용자 생성
   - groups → roles 매핑: "Strategy (T)" → User

→ DAG 목록 필터링
   - 모든 DAG 스캔
   - tags에서 "team:Strategy (T)" 찾기
   - 매칭되는 DAG만 UI에 표시

Result:
✅ strategy_us_simul_etl (보임)
✅ strategy_portfolio_rebalance (보임)
❌ hft_real_time_trading (안 보임)
❌ mft_index_constituent (안 보임)
```

**Step 3: DataHub 접근**
```
→ DataHub OIDC 로그인
→ JIT Provisioning
   - DataHub DB에 사용자 생성
   - Group 동기화: "Strategy (T)"

→ Dataset 검색
   - Owner = Strategy (T) → ✅ 조회+편집 가능
   - Owner = HFT (T) → ❌ 검색 결과에 안 나타남
   - Owner = Public → ✅ 읽기만 가능
```

### Scenario 2: HFT 팀이 Strategy 데이터 접근 시도

**DataHub에서**:
```
HFT 사용자가 "us_simul_data" 검색
→ Dataset Owner: "Strategy (T)"
→ Policies 체크:
   - User groups: ["HFT (T)"]
   - Dataset owner: "Strategy (T)"
   - Match? NO
→ Result: 검색 결과에 나타나지 않음
```

**Airflow에서**:
```
HFT 사용자가 DAG 목록 조회
→ strategy_us_simul_etl DAG
   - tags: ["team:Strategy (T)"]
→ get_permitted_dag_ids() 체크:
   - User groups: ["HFT (T)"]
   - DAG team: "Strategy (T)"
   - Match? NO
→ Result: DAG 목록에 안 나타남
```

**Snowflake에서 (향후 계획)**:
```sql
-- HFT 사용자가 직접 쿼리 시도
SELECT * FROM qraft_origin.mart.us_simul_data;

→ Snowflake Role: HFT_ROLE
→ Table Owner: STRATEGY_ROLE
→ Grant 확인: NO GRANT
→ Result: Error - Insufficient privileges
```

### Scenario 3: ML Platform (Admin) 접근

**모든 계층에서 전체 접근**:
```
Keycloak:
  groups: ["ML Platform (T)", "ml-platform-admin"]

Airflow:
  → is_admin(user) = True
  → 모든 DAG 조회+수정 가능

DataHub:
  → "ML Platform Full Admin" Policy 적용
  → 모든 엔티티 조회+편집+삭제 가능
  
Snowflake:
  → Role: ACCOUNTADMIN or SYSADMIN
  → 모든 데이터베이스/스키마 접근 가능
```

---

## 📊 격리 효과

### Before (격리 없음)

| 문제 | 발생 빈도 | 영향 |
|------|----------|------|
| **타팀 DAG 오수정** | 월 1회 | 1시간 다운타임 |
| **데이터 무단 접근** | 파악 불가 | IP 유출 우려 |
| **권한 충돌** | 주 2-3회 | Slack DM 확인 |
| **책임 소재 불명** | 매번 | 1시간+ 추적 |

### After (3계층 격리)

| 항목 | Before | After | 개선율 |
|------|--------|-------|--------|
| **타팀 DAG 오수정** | 월 1회 | 0회 | **-100%** |
| **권한 충돌** | 주 2-3회 | 0회 | **-100%** |
| **Owner 확인 시간** | 1시간+ | 5초 | **-99.8%** |
| **데이터 접근 로그** | 없음 | 자동 | **N/A** |

### 정성적 효과

**팀별 피드백**:

**Strategy (T)**:
> "이제 우리 알고리즘 데이터 안전하게 보호됨. 다른 팀 실수로 건드릴 걱정 없음"

**HFT (T)**:
> "실시간 트레이딩 파이프라인 중단 위험 제거. 운영 안정성 대폭 향상"

**ML Platform (T)**:
> "권한 문의 Slack DM 주 2-3회 → 0회. 자동화로 운영 부담 감소"

**CFO**:
> "팀별 데이터 사용 현황 한눈에 파악. 벤더 비용 협상 시 근거 확보"

---

## 🔗 관련 문서

### Projects
- [[데이터-거버넌스-전략-수립]]: 전체 거버넌스 전략
- [[DataHub-도입]]: 메타데이터 플랫폼 구축
- [[Keycloak-SSO-도입-배경]]: SSO 인증 체계
- [[데이터-카탈로그-구축]]: 검색 및 Discovery

### Technology
- [[03-Resources/Technology/Keycloak/Keycloak-OIDC-인증]]: OIDC 인증 흐름
- [[03-Resources/Technology/DataHub/Owner-Based-Policies]]: Owner 기반 정책
- [[03-Resources/Technology/Airflow/Custom-Auth-Manager]]: Airflow 권한 관리
- [[03-Resources/Technology/DataHub/URN-Encoding-통일]]: URN 일관성

### Weekly (실제 경험)
- [[2025년 10월 27일]]: 팀 간 데이터 공유 저항 ("IP 노출 우려", "왜 공유해야 하나")
- [[2025년 11월 24일]]: Keycloak 권한 관리 완료, 팀별 격리 성공

---

## 📝 교훈

### ✅ 잘한 점

1. **3계층 통합**: Keycloak → DataHub → Airflow 일관된 그룹 매핑
2. **URN 통일**: quote_plus 인코딩으로 모든 시스템 일관성 확보
3. **JIT Provisioning**: 최초 로그인 시 자동 계정 생성 → 운영 부담 감소
4. **Owner 자동 추출**: DBT _models.yml → DataHub 자동 동기화

### ⚠️ Trial & Error

1. **URN Encoding 불일치**: Keycloak (quote_plus) vs DBT (UrnEncoder) → Runtime patch
2. **Group 동기화 지연**: Keycloak → DataHub 그룹 반영 2-3분 소요 → 재로그인 안내
3. **Public Owner 혼란**: "Public" = 공개 vs 제한 → 명확한 문서화 필요
4. **Admin 권한 과다**: 초기 ML Platform 모두 Admin → 나중에 분리

### 🔮 향후 계획

1. **Snowflake RBAC**: Database-level 권한 관리
   - Strategy 팀 → STRATEGY_ROLE
   - HFT 팀 → HFT_ROLE
   - 테이블별 Grant 자동화

2. **Column-level 암호화**: 민감한 컬럼 선택적 마스킹
   - PII 데이터 → Admin만 조회
   - 알고리즘 파라미터 → 팀 Owner만 조회

3. **접근 로그 모니터링**: DataHub + Airflow audit log
   - 누가 어떤 데이터 접근했는지 추적
   - 이상 접근 패턴 감지

4. **데이터 공유 워크플로우**: 팀 간 데이터 공유 요청 프로세스
   - Slack Bot → DataHub API → Owner 승인
   - 승인 시 자동 Grant 추가

---

**작성일**: 2025-11-30  
**작성자**: ML Platform (T)  
**상태**: ✅ 운영 중, 팀별 완전 격리
